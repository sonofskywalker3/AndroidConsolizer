name: Publish to Nexus Mods

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to publish (e.g. v3.5.0). Leave empty for latest release.'
        required: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: manifest.json
          sparse-checkout-cone-mode: false

      - name: Determine release tag
        id: release
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
          elif [ -n "${{ github.event.inputs.tag }}" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=$(gh release view --json tagName -q '.tagName')
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          # Strip leading 'v' for version string
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Download release asset
        run: |
          gh release download "${{ steps.release.outputs.tag }}" \
            --pattern '*.zip' \
            --dir .
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Find ZIP file
        id: zip
        run: |
          ZIP=$(ls *.zip | head -1)
          echo "path=$ZIP" >> $GITHUB_OUTPUT
          echo "Found: $ZIP"

      - name: Upload to Nexus Mods
        uses: Nexus-Mods/upload-action@main
        with:
          api_key: ${{ secrets.NEXUS_API_KEY }}
          file_id: 41869
          game_domain_name: stardewvalley
          filename: ${{ steps.zip.outputs.path }}
          version: ${{ steps.release.outputs.version }}
          fileCategory: main
